# 📋 フリーランスマッチングプラットフォーム 機能フロー一覧

---

## 📌 使用コントローラー・サービス一覧

### 認証・登録系
- **⓪ ログイン画面表示**: 
[AuthController@showLoginForm]
 (./コントローラー/AuthController.txt:22)
- **① ログイン処理**: 
[AuthController@login]
 (./コントローラー/AuthController.txt:59)
- **② フリーランス新規登録（ログイン情報登録）**:
[AuthController@showFreelancerRegister]
 (./コントローラー/AuthController.txt:98), 
[AuthController@storeFreelancer]
 (./コントローラー/AuthController.txt:125)
- **③ フリーランス新規登録（プロフィール登録）**: 
[FreelancerProfileController@create]
 (./コントローラー/FreelancerProfileController.txt:7), 
[FreelancerProfileController@store]
 (./コントローラー/FreelancerProfileController.txt:58) → 
[FreelancerProfileService::register]
 (./サービスクラス/FreelancerProfileService.txt:5)
- **④ 企業新規登録（ログイン情報登録）**: 
[AuthController@showCompanyRegister]
 (./コントローラー/AuthController.txt:163), 
[AuthController@storeCompany]
 (./コントローラー/AuthController.txt:179)
- **⑤ 企業新規登録（プロフィール登録）**: 
[CompanyProfileController@create]
 (./コントローラー/CompanyProfileController.txt:38), 
[CompanyProfileController@store]
 (./コントローラー/CompanyProfileController.txt:87) → 
[CompanyProfileService::register]
 (./サービスクラス/CompanyProfileService.txt:5)

### フリーランス側機能
- **⑥ フリーランスプロフィール登録（初回）**: 
[FreelancerProfileController@create]
 (./コントローラー/FreelancerProfileController.txt:7), 
[FreelancerProfileController@store]
 (./コントローラー/FreelancerProfileController.txt:58) → 
[FreelancerProfileService::register]
 (./サービスクラス/FreelancerProfileService.txt:5)
- **⑦ 案件一覧表示・検索**: 
[FreelancerJobController@index]
 (./コントローラー/FreelancerJobController.txt:27)
- **⑧ 案件詳細表示**: 
[FreelancerJobController@show]
 (./コントローラー/FreelancerJobController.txt:113)
- **⑨ 案件への応募**: 
[ApplicationController@create]
 (./コントローラー/ApplicationController.txt:11), 
[ApplicationController@store]
 (./コントローラー/ApplicationController.txt:71) → 
[ApplicationService::apply]
 (./サービスクラス/ApplicationService.txt:5)
- **⑩ 応募済案件一覧表示**: 
[FreelancerApplicationController@index]
 (./コントローラー/FreelancerApplicationController.txt:18)
- **⑪ 応募チャット画面表示**: 
[FreelancerMessageController@show]
 (./コントローラー/FreelancerMessageController.txt:35) → 
[MessageService::markRead]
 (./サービスクラス/MessageService.txt:110)
- **⑫ スカウト一覧表示**: 
[FreelancerScoutController@index]
 (./コントローラー/FreelancerScoutController.txt:5)
- **⑬ スカウトチャット画面表示**: 
[FreelancerMessageController@show]
 (./コントローラー/FreelancerMessageController.txt:35) → 
[MessageService::markRead]
 (./サービスクラス/MessageService.txt:110)

### 企業側機能
- **⑭ 企業プロフィール登録（初回）**: 
[CompanyProfileController@create]
 (./コントローラー/CompanyProfileController.txt:38), 
[CompanyProfileController@store]
 (./コントローラー/CompanyProfileController.txt:87) → 
[CompanyProfileService::register]
 (./サービスクラス/CompanyProfileService.txt:5)
- **⑮ フリーランス一覧表示・検索**: 
[CompanyFreelancerController@index]
 (./コントローラー/CompanyFreelancerController.txt:14)
- **⑯ フリーランス詳細表示**: 
[CompanyFreelancerController@show]
 (./コントローラー/CompanyFreelancerController.txt:93)
- **⑰ 案件登録**: 
[CompanyJobController@create]
 (./コントローラー/CompanyJobController.txt:52), 
[CompanyJobController@store]
 (./コントローラー/CompanyJobController.txt:90) → 
[JobService::store]
 (./サービスクラス/JobService.txt:5)
- **⑱ 案件編集**: 
[CompanyJobController@edit]
 (./コントローラー/CompanyJobController.txt:150), 
[CompanyJobController@update]
 (./コントローラー/CompanyJobController.txt:192) → 
[JobService::update]
 (./サービスクラス/JobService.txt:70)
- **⑲ 案件削除**: 
[CompanyJobController@destroy]
 (./コントローラー/CompanyJobController.txt:242)
- **⑳ 案件一覧表示（企業側）**: 
[CompanyJobController@index]
 (./コントローラー/CompanyJobController.txt:7)
- **㉑ スカウト送信**: 
[ScoutController@create]
 (./コントローラー/ScoutController.txt:11), 
[ScoutController@store]
 (./コントローラー/ScoutController.txt:74) → 
[ScoutService::send]
 (./サービスクラス/ScoutService.txt:5)
- **㉒ スカウト一覧表示（企業側）**: 
ScoutController@index
- **㉓ スカウトチャット画面表示（企業側）**: 
[CompanyMessageController@show]
 (./コントローラー/CompanyMessageController.txt:32) → 
[MessageService::markRead]
 (./サービスクラス/MessageService.txt:110)
- **㉔ 応募された案件一覧表示**: 
[CompanyApplicationController@index]
 (./コントローラー/CompanyApplicationController.txt:11)
- **㉕ 応募チャット画面表示（企業側）**: 
[CompanyMessageController@show]
 (./コントローラー/CompanyMessageController.txt:32) → 
[MessageService::markRead]
 (./サービスクラス/MessageService.txt:110)

### 共通機能（チャット・未読管理）
- **㉖ チャットメッセージの送信（共通）**: 
[CompanyMessageController@store]
 (./コントローラー/CompanyMessageController.txt:132) / 
[FreelancerMessageController@store]
 (./コントローラー/FreelancerMessageController.txt:105) → 
[MessageService::send]
 (./サービスクラス/MessageService.txt:5)
- **㉗ チャットメッセージの削除（共通）**: 
[CompanyMessageController@destroy]
 (./コントローラー/CompanyMessageController.txt:216) / 
[FreelancerMessageController@destroy]
 (./コントローラー/FreelancerMessageController.txt:154)
- **㉘ 未読管理（スレッド単位）**: 
[MessageService::send]
 (./サービスクラス/MessageService.txt:5), 
[MessageService::markRead]
 (./サービスクラス/MessageService.txt:110)

---

## 目次

1. [認証・登録系](#認証登録系)
2. [フリーランス側機能](#フリーランス側機能)
3. [企業側機能](#企業側機能)
4. [共通機能（チャット・未読管理）](#共通機能チャット未読管理)

---

# 認証・登録系

## ✅ 1. ログイン処理

### 🎯 全体フロー（やさしい解説つき）

**0. ユーザーがログイン画面にアクセスする**

→ ログイン画面表示をリクエスト

→ サーバーがログインフォームを返す

**1. AuthController@showLoginForm（ログイン画面表示）**

→ ログインフォーム（view）を返すだけ（DB更新なし）

---

**2. ユーザーがログイン画面でメール・パスワードを入力**

→ メールアドレスとパスワードを送信

→ サーバーに認証をリクエスト

→ ログイン判定を開始

**3. AuthController@login**

→ ログインリクエストを受け取る

→ 認証情報をチェック

→ 成功時はroleに応じて遷移先を分岐

**4. ログイン成功後の遷移**

→ roleが'freelancer'なら案件一覧へ

→ roleが'company'ならフリーランス一覧へ

→ ユーザーの役割に応じた画面を表示

---

## ✅ 2. フリーランス新規登録（ログイン情報登録）

### 🎯 全体フロー（やさしい解説つき）

**1. ユーザーが「フリーランス新規登録」ボタンをクリック**

→ 登録画面-1を表示

→ メール・パスワードの入力フォームを表示

→ 初回登録のための準備段階

**2. ユーザーがメール・パスワードを入力して「登録」ボタンをクリック**

→ 入力データを送信

→ バリデーションチェックを依頼

→ サーバー側で検証開始

**3. AuthController@storeFreelancer（登録処理1）**

→ ログイン情報登録リクエストを受け取る

→ バリデーション（メール形式・重複チェック・パスワード強度）を実行

→ Userレコードを作成（role='freelancer'）

**4. 登録成功**

→ プロフィール登録画面-2へ遷移

→ 続けてプロフィール情報を入力

→ フリーランスとしての基本情報を登録

---

## ✅ 3. フリーランス新規登録（プロフィール登録）

### 🎯 全体フロー（やさしい解説つき）

**1. ユーザーがプロフィール情報を入力**

→ 表示名・職種・自己紹介・スキル・希望単価などを入力

→ アイコン画像をアップロード

→ すべての必須項目を埋める

**2. 「登録」ボタンをクリック**

→ プロフィールデータを送信

→ サーバーに処理を依頼

→ 登録処理を開始

**3. FreelancerProfileController@create（登録画面表示）**

→ プロフィール登録リクエストを受け取る

→ FreelancerProfileServiceに処理を委譲

→ サービス層でビジネスロジックを実行

**4. FreelancerProfileController@store → FreelancerProfileService::register**

→ バリデーションを実行（必須項目・単価下限上限チェック・URL形式チェック）

→ Freelancerレコード・スキル・カスタムスキル・ポートフォリオを一括作成

→ トランザクション内で整合性を保証

**5. 登録完了**

→ 案件一覧画面へ遷移

→ フリーランスとしてのサービス利用開始

→ 案件検索が可能になる

---

## ✅ 4. 企業新規登録（ログイン情報登録）

### 🎯 全体フロー（やさしい解説つき）

**1. ユーザーが「企業新規登録」ボタンをクリック**

→ 登録画面-1を表示

→ メール・パスワードの入力フォームを表示

→ 初回登録のための準備段階

**2. ユーザーがメール・パスワードを入力して「登録」ボタンをクリック**

→ 入力データを送信

→ バリデーションチェックを依頼

→ サーバー側で検証開始

**3. AuthController@storeCompany（登録処理1）**

→ ログイン情報登録リクエストを受け取る

→ バリデーション（メール形式・重複チェック・パスワード強度）を実行

→ Userレコードを作成（role='company'）

**4. 登録成功**

→ プロフィール登録画面-2へ遷移

→ 続けて企業情報を入力

→ 企業としての基本情報を登録

---

## ✅ 5. 企業新規登録（プロフィール登録）

### 🎯 全体フロー（やさしい解説つき）

**1. ユーザーが企業情報を入力**

→ 企業名・会社概要・担当者名・部署・自己紹介などを入力

→ 必須項目を埋める

→ 企業プロフィールを完成させる

**2. 「登録」ボタンをクリック**

→ 企業データを送信

→ サーバーに処理を依頼

→ 登録処理を開始

**3. CompanyProfileController@create（登録画面表示）**

→ プロフィール登録リクエストを受け取る

→ バリデーションを実行（企業名必須など）

→ Companyレコードを作成

**4. CompanyProfileController@store → CompanyProfileService::register**

**5. 登録完了**

→ フリーランス一覧画面へ遷移

→ 企業としてのサービス利用開始

→ フリーランス検索・案件登録が可能になる

---

# フリーランス側機能

## ✅ 6. フリーランスプロフィール編集

### 🎯 全体フロー（やさしい解説つき）

**1. フリーランスが「プロフィール設定」をクリック**

→ 現在のプロフィール情報を取得

→ 編集画面を表示

→ 既存データを入力欄に表示

**2. FreelancerProfileController@create（プロフィール登録画面表示）**

→ 認証済みフリーランスのプロフィール取得

→ スキル・カスタムスキル・ポートフォリオをEager Loading

→ Viewにデータを渡して編集フォームを表示

※注意：詳細設計にeditメソッドの記載がないため、基本設計のバリデーション定義に基づき編集機能は存在するが、詳細設計が不完全な可能性がある

**3. ユーザーがプロフィールを修正して「更新」ボタンをクリック**

→ 修正データを送信

→ サーバーに更新処理を依頼

→ 更新処理を開始

**4. FreelancerProfileController@store**

→ 更新リクエストを受け取る

→ FreelancerProfileServiceに処理を委譲

→ サービス層でビジネスロジックを実行

※プロフィール登録の実処理は `FreelancerProfileService::register` に委譲する

**6. 更新完了**

→ プロフィール設定画面に戻る

→ 成功メッセージを表示

→ 更新された情報が反映される

---

## ✅ 7. 案件一覧表示・検索

### 🎯 全体フロー（やさしい解説つき）

**1. フリーランスが案件一覧画面にアクセス**

→ 公開中の案件を取得

→ 一覧表示をリクエスト

→ データ取得を開始

**2. FreelancerJobController@index**

→ 一覧表示リクエストを受け取る

→ コントローラーで直接検索処理を実行

**3. コントローラーでの検索処理**

→ status=1（公開）の案件のみ取得

→ キーワード検索があればLIKE検索を実行（タイトル・説明・必要スキルなど横断検索）

→ 報酬レンジでフィルタリング（指定があれば）

**4. 検索結果を画面に表示**

→ 案件カードを一覧表示

→ 各案件の基本情報・企業名・報酬・稼働時間を表示

→ 「詳細」「応募」ボタンを配置

---

## ✅ 8. 案件詳細表示

### 🎯 全体フロー（やさしい解説つき）

**1. フリーランスが案件カードの「詳細」ボタンをクリック**

→ 案件IDを指定して詳細をリクエスト

→ サーバーに案件情報を要求

→ 詳細データ取得を開始

**2. FreelancerJobController@show**

→ 案件詳細リクエストを受け取る

→ Route Model Bindingで案件を取得（status=1のみ）

→ コントローラーで既応募判定を実行（Applicationモデルで直接確認）

**3. 案件詳細画面を表示**

→ 案件の全文情報（タイトル・説明・必要スキル・報酬・稼働時間）を表示

→ 企業情報を表示

→ 応募ボタンの状態を判定（未応募なら「応募する」、応募済みなら「応募済み（チャットを開く）」）

---

## ✅ 9. 案件への応募

### 🎯 全体フロー（やさしい解説つき）

**1. フリーランスが案件詳細画面で「応募する」ボタンをクリック**

→ 応募入力画面へ遷移

→ 応募メッセージ入力フォームを表示

→ アピール文を記述する準備

**2. ApplicationController@create**

→ 応募フォーム表示リクエストを受け取る

→ 既応募チェック（重複応募防止）を実行

→ 案件情報を取得してViewに渡す

**3. ユーザーが応募メッセージを入力して「応募（送信）」ボタンをクリック**

→ 応募メッセージを送信

→ サーバーに応募処理を依頼

→ 応募レコード作成を開始

**4. ApplicationController@store**

→ 応募リクエストを受け取る

→ ApplicationServiceに処理を委譲

→ サービス層でビジネスロジックを実行

**5. ApplicationService::apply**

→ 重複応募チェック（同じ案件への応募は1回のみ）

→ Applicationレコードを作成（status=0（未対応））

→ チャットスレッドを自動生成（Threadレコード作成）

→ 応募メッセージを最初のメッセージとして保存

→ 未読フラグを企業側にセット（is_unread_for_company=true）

**7. 応募完了**

→ 応募チャット画面へ即座に遷移（MVPの導線）

→ 応募メッセージが先頭に表示されたチャット画面を表示

→ 企業側ヘッダーの「応募された案件」に未読バッジ+1

---

## ✅ 10. 応募済案件一覧表示

### 🎯 全体フロー（やさしい解説つき）

**1. フリーランスがヘッダーの「応募した案件」をクリック**

→ 応募済案件一覧をリクエスト

→ サーバーに応募リストを要求

→ データ取得を開始

**2. FreelancerApplicationController@index**

→ 一覧表示リクエストを受け取る

→ statusパラメータに応じてフィルタリング（pending=応募中、closed=終了）

→ 認証フリーランスの応募をEager Loadingで取得（job、company、thread含む）

**3. コントローラーでの処理**

→ フリーランスIDで応募を絞り込み

→ タブ切替に応じてステータスフィルタリング（status=0,1なら応募中、status=2なら終了）

→ 各スレッドの未読判定を実行（latest_sender_type!='freelancer'なら未読）

**4. 応募一覧画面を表示**

→ 応募中/終了のタブを表示

→ 各案件カードに未読バッジを表示（未読スレッドのみ）

→ 「チャット画面へ」ボタンを配置

---

## ✅ 11. 応募チャット画面表示

### 🎯 全体フロー（やさしい解説つき）

**1. フリーランスが応募一覧から案件カードをクリック**

→ チャット画面へ遷移

→ スレッドIDを指定してチャットをリクエスト

→ チャット履歴の取得を開始

**2. FreelancerMessageController@show**

→ チャット画面表示リクエストを受け取る

→ Route Model Bindingでスレッドを取得

→ 権限チェック（ログインフリーランスが当事者かどうか）を実行

**3. コントローラーでの処理**

→ スレッドに紐づくメッセージをEager Loadingで取得

→ company、job、application、messagesをすべて取得

→ 時系列順（sent_at）でメッセージをソート

**4. MessageService::markRead**

→ 未読フラグを解除（is_unread_for_freelancer=false）

→ チャット画面を開いた時点で既読扱い

→ スレッド単位で未読管理

**5. チャット画面を表示**

→ 最初のメッセージ（応募文）を先頭に固定表示

→ メッセージ一覧を時系列で表示（左：自分、右：企業）

→ 入力欄と送信ボタンを配置（応募がクローズ状態なら無効化）

---

## ✅ 12. スカウト一覧表示

### 🎯 全体フロー（やさしい解説つき）

**1. フリーランスがヘッダーの「スカウト」をクリック**

→ 受信したスカウト一覧をリクエスト

→ サーバーにスカウトリストを要求

→ データ取得を開始

**2. FreelancerScoutController@index**

→ 一覧表示リクエストを受け取る

→ コントローラーで直接スカウト取得を実行

**3. コントローラーでの処理**

→ 認証フリーランスのIDでスカウトを絞り込み

→ company、thread、latestMessageをEager Loadingで取得

→ 各スレッドの未読判定を実行（latest_sender_type!='freelancer'なら未読）

**4. スカウト一覧画面を表示**

→ スカウトカードを一覧表示

→ 企業名・担当者名・スカウトメッセージを表示

→ 未読バッジを表示（未読スレッドのみ）

---

## ✅ 13. スカウトチャット画面表示

### 🎯 全体フロー（やさしい解説つき）

**1. フリーランスがスカウト一覧からカードをクリック**

→ チャット画面へ遷移

→ スレッドIDを指定してチャットをリクエスト

→ チャット履歴の取得を開始

**2. FreelancerMessageController@show**

→ チャット画面表示リクエストを受け取る

→ Route Model Bindingでスレッドを取得

→ 権限チェック（ログインフリーランスが当事者かどうか）を実行

**3. コントローラーでの処理**

→ スレッドに紐づくメッセージをEager Loadingで取得

→ company、scout、messagesをすべて取得

→ 時系列順（sent_at）でメッセージをソート

**4. MessageService::markRead**

→ 未読フラグを解除（is_unread_for_freelancer=false）

→ チャット画面を開いた時点で既読扱い

→ スレッド単位で未読管理

**5. チャット画面を表示**

→ 最初のメッセージ（スカウト文）を先頭に固定表示

→ メッセージ一覧を時系列で表示（左：自分、右：企業）

→ 入力欄と送信ボタンを配置（スカウトがクローズ状態なら無効化）

---

# 企業側機能

## ✅ 14. 企業プロフィール編集

### 🎯 全体フロー（やさしい解説つき）

**1. 企業が「プロフィール設定」をクリック**

→ 現在の企業情報を取得

→ 編集画面を表示

→ 既存データを入力欄に表示

**2. CompanyProfileController@create（企業プロフィール登録画面表示）**

→ 認証済み企業のプロフィール取得

→ Viewにデータを渡して編集フォームを表示

→ 企業名・会社概要・担当者名・部署・自己紹介を表示

※注意：詳細設計にeditメソッドの記載がないため、基本設計のビュー定義に基づき編集機能は存在するが、詳細設計が不完全な可能性がある

**3. ユーザーが企業情報を修正して「更新」ボタンをクリック**

→ 修正データを送信

→ サーバーに更新処理を依頼

→ 更新処理を開始

**4. CompanyProfileController@store → CompanyProfileService::register**

→ 更新リクエストを受け取る

→ バリデーションを実行（企業名必須など）

→ Companyレコードを更新

※企業プロフィール登録の実処理は `CompanyProfileService::register` に委譲する

**5. 更新完了**

→ プロフィール設定画面に戻る

→ 成功メッセージを表示

→ 更新された情報が反映される

---

## ✅ 15. フリーランス一覧表示・検索

### 🎯 全体フロー（やさしい解説つき）

**1. 企業がフリーランス一覧画面にアクセス**

→ 登録済みフリーランスを取得

→ 一覧表示をリクエスト

→ データ取得を開始

**2. CompanyFreelancerController@index**

→ 一覧表示リクエストを受け取る

→ コントローラーで直接検索処理を実行

**3. コントローラーでの検索処理**

→ キーワード検索があればLIKE検索を実行（表示名・職種・自己紹介・スキル・経験企業など横断検索）

→ 希望単価でフィルタリング（指定があれば）

→ skills、custom_skills、portfoliosをEager Loadingで取得

**4. 検索結果を画面に表示**

→ 左サイドバーに検索フォーム配置

→ 中央カラムにフリーランスカード一覧表示

→ 右サイドバーは初期状態では空（クリック時に詳細表示）

---

## ✅ 16. フリーランス詳細表示

### 🎯 全体フロー（やさしい解説つき）

**1. 企業がフリーランスカードをクリック**

→ フリーランスIDを指定して詳細をリクエスト

→ サーバーにフリーランス情報を要求

→ 詳細データ取得を開始

**2. CompanyFreelancerController@show**

→ フリーランス詳細リクエストを受け取る

→ Route Model Bindingでフリーランスを取得

→ skills、custom_skills、portfoliosをEager Loadingで取得

**3. 右サイドバーに詳細情報を表示**

→ アイコン・表示名・職種・自己紹介（全文）を表示

→ スキル・経験企業・ワークスタイル・希望単価を表示

→ ポートフォリオURLをリンク形式で表示

**4. 「スカウト」ボタンを配置**

→ クリックでスカウト入力画面へ遷移

→ フリーランスIDを引き継ぐ

→ スカウト送信の準備

---

## ✅ 17. 案件登録

### 🎯 全体フロー（やさしい解説つき）

**1. 企業が「新規登録」ボタンをクリック**

→ 案件登録フォームを表示

→ 空の入力欄を表示

→ 新規案件情報の入力準備

**2. CompanyJobController@create**

→ 登録フォーム表示リクエストを受け取る

→ 空のフォームを返す

→ View表示のみ

**3. ユーザーが案件情報を入力して「登録」ボタンをクリック**

→ 案件データを送信

→ サーバーに登録処理を依頼

→ 案件レコード作成を開始

**4. CompanyJobController@store**

→ 登録リクエストを受け取る

→ JobServiceに処理を委譲

→ サービス層でビジネスロジックを実行

**5. JobService::store**

→ バリデーションを実行（タイトル必須・報酬下限上限チェックなど）

→ Jobレコードを作成（company_idを紐付け）

→ ステータスに応じて公開/下書き/停止を設定

**6. 登録完了**

→ 自社案件一覧画面へ遷移

→ 新規案件が一覧に追加される

→ 公開状態なら即座にフリーランス側の一覧に表示される

---

## ✅ 18. 案件編集

### 🎯 全体フロー（やさしい解説つき）

**1. 企業が案件一覧から「編集」ボタンをクリック**

→ 案件編集画面へ遷移

→ 既存の案件情報を取得

→ 編集フォームに既存データを表示

**2. CompanyJobController@edit**

→ 編集フォーム表示リクエストを受け取る

→ Route Model Bindingで案件を取得（company_id一致チェック）

→ Viewにデータを渡して編集フォームを表示

**3. ユーザーが案件情報を修正して「更新」ボタンをクリック**

→ 修正データを送信

→ サーバーに更新処理を依頼

→ 更新処理を開始

**4. CompanyJobController@update**

→ 更新リクエストを受け取る

→ JobServiceに処理を委譲

→ サービス層でビジネスロジックを実行

**5. JobService::update**

→ バリデーションを実行

→ Jobレコードを更新

→ ステータス変更があればフリーランス側の表示に反映

**6. 更新完了**

→ 自社案件一覧画面に戻る

→ 成功メッセージを表示

→ 更新された情報が反映される

---

## ✅ 19. 案件削除

### 🎯 全体フロー（やさしい解説つき）

**1. 企業が案件一覧から「削除」ボタンをクリック**

→ 削除確認ダイアログを表示

→ ユーザーに削除の最終確認を求める

→ 誤操作防止

**2. ユーザーが削除を確認**

→ 削除リクエストを送信

→ サーバーに削除処理を依頼

→ 削除処理を開始

**3. CompanyJobController@destroy**

→ 削除リクエストを受け取る

→ Route Model Bindingで案件を取得（company_id一致チェック）

→ コントローラーで直接削除処理を実行

**4. コントローラーでの削除処理**

→ 案件に紐づく応募・スレッドの存在チェック（削除可否判定）

→ 問題なければJobレコードを削除

→ 関連するスレッドは保持（チャット履歴を残す運用）

**5. 削除完了**

→ 自社案件一覧画面に戻る

→ 削除された案件が一覧から消える

→ フリーランス側の一覧からも削除される

---

## ✅ 20. 案件一覧表示（企業側）

### 🎯 全体フロー（やさしい解説つき）

**1. 企業が「自社案件一覧」にアクセス**

→ 自社が作成した案件を取得

→ 一覧表示をリクエスト

→ データ取得を開始

**2. CompanyJobController@index**

→ 一覧表示リクエストを受け取る

→ コントローラーで直接取得処理を実行

**3. コントローラーでの処理**

→ 認証企業のIDで案件を絞り込み

→ ステータスに関係なくすべての案件を取得（公開/下書き/停止すべて）

→ キーワード検索があればLIKE検索を実行

**4. 案件一覧画面を表示**

→ 案件カードを一覧表示（タイトル・報酬・稼働時間・ステータスを表示）

→ 「編集」「削除」ボタンを配置

→ 「新規登録」ボタンを配置

---

## ✅ 21. スカウト送信

### 🎯 全体フロー（やさしい解説つき）

**1. 企業がフリーランス詳細画面で「スカウト」ボタンをクリック**

→ スカウト入力画面へ遷移

→ スカウトメッセージ入力フォームを表示

→ フリーランスIDを引き継ぐ

**2. ScoutController@create**

→ スカウトフォーム表示リクエストを受け取る

→ freelancer_idをクエリパラメータから取得

→ フリーランス情報を取得してViewに渡す

**3. ユーザーがスカウトメッセージを入力して「送信」ボタンをクリック**

→ スカウトメッセージを送信

→ サーバーにスカウト処理を依頼

→ スカウトレコード作成を開始

**4. ScoutController@store**

→ スカウトリクエストを受け取る

→ ScoutServiceに処理を委譲

→ サービス層でビジネスロジックを実行

**5. ScoutService::send**

→ 重複スカウトチェック（任意：同じ企業から同じフリーランスへの重複スカウト防止）

→ Scoutレコードを作成（status=0（未対応））

→ チャットスレッドを自動生成（Threadレコード作成、既存スレッドがあれば再利用）

→ スカウトメッセージを最初のメッセージとして保存

→ 未読フラグをフリーランス側にセット（is_unread_for_freelancer=true）

**7. スカウト送信完了**

→ フリーランス一覧画面へ戻る

→ 送信完了メッセージを表示

→ フリーランス側ヘッダーの「スカウト」に未読バッジ+1

---

## ✅ 22. スカウト一覧表示（企業側）

### 🎯 全体フロー（やさしい解説つき）

**1. 企業がヘッダーの「スカウト」をクリック**

→ 送信したスカウト一覧をリクエスト

→ サーバーにスカウトリストを要求

→ データ取得を開始

**2. ScoutController@index**

→ 一覧表示リクエストを受け取る

→ コントローラーで直接スカウト取得を実行

**3. コントローラーでの処理**

→ 認証企業のIDでスカウトを絞り込み

→ freelancer、job、threadをEager Loadingで取得

→ 各スレッドの未読判定を実行（latest_sender_type!='company'なら未読）

**4. スカウト一覧画面を表示**

→ スカウトカードを一覧表示

→ フリーランス名・スカウトメッセージ・送信日時を表示

→ 未読バッジを表示（未読スレッドのみ）

---

## ✅ 23. スカウトチャット画面表示（企業側）

### 🎯 全体フロー（やさしい解説つき）

**1. 企業がスカウト一覧からカードをクリック**

→ チャット画面へ遷移

→ スレッドIDを指定してチャットをリクエスト

→ チャット履歴の取得を開始

**2. CompanyMessageController@show**

→ チャット画面表示リクエストを受け取る

→ Route Model Bindingでスレッドを取得

→ 権限チェック（ログイン企業が当事者かどうか）を実行

**3. コントローラーでの処理**

→ スレッドに紐づくメッセージをEager Loadingで取得

→ freelancer、scout、messagesをすべて取得

→ 時系列順（sent_at）でメッセージをソート

**4. MessageService::markRead**

→ 未読フラグを解除（is_unread_for_company=false）

→ チャット画面を開いた時点で既読扱い

→ スレッド単位で未読管理

**5. チャット画面を表示**

→ 最初のメッセージ（スカウト文）を先頭に固定表示

→ メッセージ一覧を時系列で表示（左：フリーランス、右：自分）

→ 入力欄と送信ボタンを配置（スカウトがクローズ状態なら無効化）

---

## ✅ 24. 応募された案件一覧表示

### 🎯 全体フロー（やさしい解説つき）

**1. 企業がヘッダーの「応募された案件」をクリック**

→ 応募を受けた案件一覧をリクエスト

→ サーバーに応募リストを要求

→ データ取得を開始

**2. CompanyApplicationController@index**

→ 一覧表示リクエストを受け取る

→ statusパラメータに応じてフィルタリング（pending=応募中、closed=終了）

→ 自社案件への応募をEager Loadingで取得（job、freelancer、thread含む）

**3. コントローラーでの処理**

→ 認証企業のIDに紐づく案件への応募を絞り込み

→ タブ切替に応じてステータスフィルタリング（status=0,1なら応募中、status=2なら終了）

→ 各スレッドの未読判定を実行（latest_sender_type!='company'なら未読）

**4. 応募一覧画面を表示**

→ 応募中/終了のタブを表示

→ 各案件カードに応募情報（フリーランス名・応募メッセージ・未読バッジ）を表示

→ 「チャット画面へ」ボタンを配置

---

## ✅ 25. 応募チャット画面表示（企業側）

### 🎯 全体フロー（やさしい解説つき）

**1. 企業が応募一覧から案件カードをクリック**

→ チャット画面へ遷移

→ スレッドIDを指定してチャットをリクエスト

→ チャット履歴の取得を開始

**2. CompanyMessageController@show**

→ チャット画面表示リクエストを受け取る

→ Route Model Bindingでスレッドを取得

→ 権限チェック（ログイン企業が当事者かどうか）を実行

**3. コントローラーでの処理**

→ スレッドに紐づくメッセージをEager Loadingで取得

→ freelancer、job、application、messagesをすべて取得

→ 時系列順（sent_at）でメッセージをソート

**4. MessageService::markRead**

→ 未読フラグを解除（is_unread_for_company=false）

→ チャット画面を開いた時点で既読扱い

→ スレッド単位で未読管理

**5. チャット画面を表示**

→ 最初のメッセージ（応募文）を先頭に固定表示

→ メッセージ一覧を時系列で表示（左：フリーランス、右：自分）

→ 入力欄と送信ボタンを配置（応募がクローズ状態なら無効化）

**6. 応募ステータス更新機能を配置**

→ 未対応→対応中→クローズのステータス切替ボタンを配置

→ ステータス変更はコントローラーで直接実行（Applicationモデルを更新）

→ クローズにすると応募中タブから終了タブへ移動

※注意：基本設計のルーティング定義に応募ステータス更新専用のルーティングが記載されていないため、CompanyMessageController内で処理する形で統一

---

# 共通機能（チャット・未読管理）

## ✅ 26. チャットメッセージの送信（企業/フリーランス共通）

### 🎯 全体フロー（やさしい解説つき）

**1. ユーザーがチャット画面でメッセージを入力して「送信」ボタンをクリック**

→ メッセージ本文を送信

→ サーバーにメッセージ送信処理を依頼

→ メッセージレコード作成を開始

**2. CompanyMessageController@store / FreelancerMessageController@store**

→ メッセージ送信リクエストを受け取る（送信者の種別に応じてControllerが分岐）

→ MessageServiceに処理を委譲

→ サービス層でビジネスロジックを実行

**3. MessageService::send**

→ Messageレコードを作成（thread_id、sender_type、sender_id、body、sent_at）

→ Threadレコードを更新（latest_sender_type、latest_sender_id、latest_message_at）

→ 相手側の未読フラグをセット（sender_type='company'なら is_unread_for_freelancer=true、逆も然り）

**4. メッセージ送信完了**

→ チャット画面に新しいメッセージを表示

→ 相手側のヘッダーに未読バッジ+1（スレッド単位）

→ リアルタイム感を演出（ページリロードで最新状態を表示）

---

## ✅ 27. チャットメッセージの削除（企業/フリーランス共通）

### 🎯 全体フロー（やさしい解説つき）

**1. ユーザーが自分のメッセージの「削除」ボタンをクリック**

→ 削除確認を表示

→ ユーザーに削除の最終確認を求める

→ 誤操作防止

**2. ユーザーが削除を確認**

→ 削除リクエストを送信

→ サーバーに削除処理を依頼

→ ソフト削除を開始

**3. CompanyMessageController@destroy / FreelancerMessageController@destroy**

→ 削除リクエストを受け取る（送信者の種別に応じてControllerが分岐）

→ Route Model Bindingでメッセージを取得

→ 自分のメッセージかどうかをチェック（sender_type・sender_id一致チェック）

**4. コントローラーでの削除処理**

→ deleted_atカラムに現在日時を設定（ソフト削除）

→ 物理削除ではなく論理削除を実行

→ データベースには残すが画面には表示しない

**5. 削除完了**

→ チャット画面から削除されたメッセージが消える

→ 削除されたメッセージは「削除されました」と表示（任意）

→ 相手側には削除が反映される

---

## ✅ 28. 未読管理（スレッド単位）

### 🎯 全体フロー（やさしい解説つき）

**1. メッセージが送信される**

→ 送信者の反対側に未読フラグを立てる

→ スレッド単位で未読を管理

→ 個別メッセージではなくスレッド全体で判定

**2. MessageService::send（未読フラグセット）**

→ Threadレコードのlatest_sender_typeを更新

→ sender_type='company'なら is_unread_for_freelancer=true

→ sender_type='freelancer'なら is_unread_for_company=true

**3. 未読バッジ表示**

→ ヘッダーの「応募した案件」「スカウト」に未読数を表示

→ 未読スレッド数を集計して表示

→ スレッド単位なので集計が軽量

**4. チャット画面を開く**

→ MessageService::markReadで未読フラグを解除

→ is_unread_for_freelancer または is_unread_for_company を false に設定

→ 画面を開いた時点で既読扱い

**5. 未読バッジが消える**

→ ヘッダーの未読数が-1される

→ 未読スレッドが0になればバッジも消える

→ リアルタイム感を演出（ページリロードで最新状態を表示）

---

# 📌 機能フロー設計のポイントまとめ

## コントローラーとサービスの役割分担

1. **コントローラー（入口役）**：
   - リクエストを受け取る
   - 権限チェック・認証チェックを実行
   - サービス層に処理を委譲
   - Viewにデータを渡す

2. **サービス層（ビジネスロジック）**：
   - バリデーションを実行
   - データベース操作を実行
   - トランザクション管理
   - 複雑なロジックを集約

## 主要な処理パターン

1. **登録処理**：
   - バリデーション → レコード作成 → リダイレクト

2. **一覧表示**：
   - 絞り込み条件取得 → データベース検索 → Eager Loading → View表示

3. **詳細表示**：
   - Route Model Binding → 権限チェック → Eager Loading → View表示

4. **チャット生成**：
   - 応募/スカウト送信 → スレッド自動生成 → 最初のメッセージ保存 → 未読フラグセット

5. **未読管理**：
   - メッセージ送信時に相手側未読フラグセット → チャット画面開いた時点で既読化

## トランザクション管理が必要な処理

1. **フリーランスプロフィール登録・編集**：
   - Freelancerレコード + スキル + カスタムスキル + ポートフォリオを一括処理

2. **応募送信**：
   - Applicationレコード作成 + Threadレコード作成 + 最初のMessageレコード作成

3. **スカウト送信**：
   - Scoutレコード作成 + Threadレコード作成 + 最初のMessageレコード作成

## パフォーマンス考慮

1. **Eager Loading**：
   - N+1問題を回避するため、リレーションを事前に読み込む

2. **スレッド単位の未読管理**：
   - メッセージ単位ではなくスレッド単位で未読を管理し、集計を軽量化

3. **ページネーション**：
   - 一覧取得時は適切な件数でページネーションを実装

4. **インデックス**：
   - 検索対象のカラムにインデックスを設定して検索速度を向上

---

以上、全機能のフローをまとめました。
