# 🟩 ApplicationService：1つのメソッドの処理の流れ（初心者向け・段階的）

---

# ① **apply（応募処理）**

「フリーランスが案件に応募し、チャットスレッドを自動生成する」ためのメソッド。

---

## ⭐ 全体のイメージ

1つの応募が確定するまでに、

**応募レコード作成 → チャットスレッド生成 → 最初のメッセージ作成 → 未読フラグ設定**

という "一連の手続き" がまとめて行われる。

---

## 🔽 処理の流れ（ステップごとに優しく）

### **1. 応募できる状態かどうか確認する**

- 案件が存在するか
- 既に応募済みでないか（重複応募チェック）
- 案件が公開状態（status = 'published'）か
- フリーランスの権限に問題がないか

→ この時点で問題があれば応募は中断し、エラーを返す。

---

### **2. トランザクションを開始する**

- 複数のテーブル（applications, threads, messages）を同時に更新するため
- 途中でエラーが発生した場合、すべての変更を元に戻す必要がある

---

### **3. DB（applications テーブル）に応募データを作成する**

- freelancer_id を保存
- job_id を保存
- status を「pending」（未対応）に設定
- created_at / updated_at を保存

---

### **4. チャット用スレッド（threads テーブル）を生成する**

- freelancer_id を保存
- company_id（案件の企業ID）を保存
- type を「application」（応募タイプ）に設定
- last_sender_id を $freelancer_id に設定（最後の送信者）
- is_freelancer_unread を false に設定
- is_company_unread を true に設定（企業側が未読）

※ 既に同じ組み合わせ（企業 × フリーランス × 案件）のスレッドが存在する場合は、再利用する

---

### **5. 最初の応募メッセージ（messages テーブル）を作成する**

- thread_id を保存
- sender_id を $freelancer_id に設定
- content を $message_content（応募メッセージ本文）に設定
- created_at / updated_at を保存

---

### **6. トランザクションをコミットする**

- すべての処理が成功した場合、変更を確定する

---

### **7. エラー時はロールバックする**

- 途中でエラーが発生した場合、すべての変更を元に戻す

---

### **8. 全体として「応募が確定した状態」を返す**

- 作成された Application モデル
- 作成された Thread モデル
- 画面に表示する成功メッセージなど

---

---

# 🟦 💡 全体まとめ：applyメソッドの処理内容

+------------------+------------------------+----------------------------------+
| 処理内容         | DB更新                 | 主な目的                         |
+------------------+------------------------+----------------------------------+
| 応募レコード作成 | applications テーブル  | 応募履歴を記録する               |
| スレッド生成     | threads テーブル        | チャットの部屋を作る             |
| メッセージ作成   | messages テーブル      | 最初の応募メッセージを保存する   |
| 未読フラグ設定   | threads テーブル        | 企業側に未読通知を表示する       |
+------------------+------------------------+----------------------------------+

---

## 📌 エラーハンドリング

+------------------------+------------------------------------------+
| エラーケース           | 対応                                      |
+------------------------+------------------------------------------+
| 案件が存在しない       | 404エラー（例外をスロー）                 |
| 既に応募済み           | バリデーションエラー（例外をスロー）     |
| 案件が公開状態でない   | バリデーションエラー（例外をスロー）     |
| メッセージ内容が空     | バリデーションエラー（例外をスロー）     |
| DBエラー               | ロールバック後、例外をスロー             |
+------------------------+------------------------------------------+

---

## 🔗 関連モデル

- Application
- Job
- Thread
- Message
- User
- Company

---

## 💡 実装メモ

- 応募後は即座にチャット画面へ遷移する仕様
- 最初の応募メッセージはチャット最上部に固定表示される
- 未読判定は「最後の送信者が自分以外かどうか」で判定
- 同じ組み合わせ（企業 × フリーランス × 案件）のスレッドは1つだけ存在する
