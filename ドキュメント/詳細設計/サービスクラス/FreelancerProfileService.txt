# 🟩 FreelancerProfileService：1つのメソッドの処理の流れ（初心者向け・段階的）

---

# ① **register（プロフィール登録処理）**

「フリーランスのプロフィール情報を一括登録する」ためのメソッド。

---

## ⭐ 全体のイメージ

1つのプロフィール登録が確定するまでに、

**基本情報保存 → 稼働条件保存 → スキル関連付け → 単価情報保存**

という "一連の手続き" がまとめて行われる。

---

## 🔽 処理の流れ（ステップごとに優しく）

### **1. 登録できる状態かどうか確認する**

- ユーザーが存在するか
- 既にプロフィールが登録されていないか（重複登録チェック）
- 入力データのバリデーション（必須項目チェックなど）

→ この時点で問題があれば登録は中断し、エラーを返す。

---

### **2. トランザクションを開始する**

- 複数のテーブル（freelancer_profiles, freelancer_skill など）を同時に更新するため
- 途中でエラーが発生した場合、すべての変更を元に戻す必要がある

---

### **3. DB（freelancer_profiles テーブル）に基本情報を保存する**

保存するカラム：

- user_id
- name（表示名）
- bio（自己紹介文）
- portfolio_url
- min_hours_per_week（週の最小稼働時間）
- max_hours_per_week（週の最大稼働時間）
- hours_per_day（1日の稼働時間）
- days_per_week（週の稼働日数）
- rate_type（monthly / hourly）
- min_rate（希望単価の下限）
- max_rate（希望単価の上限）
- created_at / updated_at

---

### **4. スキル情報を関連付けする**

- `freelancer_skill` 中間テーブルを使用
- 既存のスキル関連付けがあれば削除してから新規登録
- 複数スキルを配列で受け取り、一括登録

※ スキルIDが存在しない場合はエラーを返す

---

### **5. カスタムスキル（自由入力スキル）を登録する**

- `freelancer_custom_skill` テーブルに保存
- 複数のカスタムスキルに対応

---

### **6. ポートフォリオURLを登録する**

- `freelancer_portfolio` テーブルに保存
- 複数のポートフォリオURLに対応

---

### **7. トランザクションをコミットする**

- すべての処理が成功した場合、変更を確定する

---

### **8. エラー時はロールバックする**

- 途中でエラーが発生した場合、すべての変更を元に戻す

---

### **9. 全体として「プロフィール登録が確定した状態」を返す**

- 作成された FreelancerProfile モデル
- 画面に表示する成功メッセージなど

---

---

# 🟦 💡 全体まとめ：registerメソッドの処理内容

+------------------+----------------------------------+----------------------------------+
| 処理内容         | DB更新                           | 主な目的                         |
+------------------+----------------------------------+----------------------------------+
| 基本情報保存     | freelancer_profiles テーブル     | プロフィールの基本情報を記録する |
| 稼働条件保存     | freelancer_profiles テーブル     | 稼働可能時間・日数を記録する     |
| スキル関連付け   | freelancer_skill 中間テーブル    | スキルタグを関連付ける           |
| カスタムスキル登録 | freelancer_custom_skill テーブル | 自由入力スキルを保存する         |
| ポートフォリオ登録 | freelancer_portfolio テーブル   | ポートフォリオURLを保存する      |
| 単価情報保存     | freelancer_profiles テーブル     | 希望単価レンジを記録する         |
+------------------+----------------------------------+----------------------------------+

---

## 📌 エラーハンドリング

+------------------------+------------------------------------------+
| エラーケース           | 対応                                      |
+------------------------+------------------------------------------+
| バリデーションエラー   | 例外をスロー（Controller側でキャッチ）   |
| 既にプロフィール登録済み | バリデーションエラー（例外をスロー）   |
| スキルIDが存在しない   | バリデーションエラー（例外をスロー）   |
| DBエラー               | ロールバック後、例外をスロー             |
+------------------------+------------------------------------------+

---

## 🔗 関連モデル

- User
- FreelancerProfile
- Skill
- FreelancerSkill（中間テーブル）
- FreelancerCustomSkill
- FreelancerPortfolio

---

## 💡 実装メモ

- プロフィールは "検索・表示用データ" として使われる前提（企業検索の判断材料）
- 稼働条件は4カラム（min_hours_per_week, max_hours_per_week, hours_per_day, days_per_week）で管理
- 希望単価は月額／時給どちらも保存可能
- スキルは複数選択可能で、中間テーブルで管理
