# âœ… CompanyMessageControllerï¼ˆãƒãƒ£ãƒƒãƒˆé€ä¿¡ãƒ»å‰Šé™¤ï¼‰è©³ç´°è¨­è¨ˆ

ã“ã®Controllerã¯ä¼æ¥­å´ã§ä»¥ä¸‹ã‚’æ‹…å½“ğŸ‘‡

+----------+------------------------------------------+
| å½¹å‰²     | å‹•ä½œ                                      |
+----------+------------------------------------------+
| threadè¡¨ç¤º | ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤ºï¼ˆã‚¹ã‚«ã‚¦ãƒˆãƒ»å¿œå‹Ÿä¸¡æ–¹ï¼‰ |
| messageé€ä¿¡ | æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ•ç¨¿                      |
| messageå‰Šé™¤ | æœ€æ–°ã®è‡ªåˆ†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤                |
| æœªèª­è§£é™¤ | thread ã‚’é–‹ã„ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ—¢èª­æ‰±ã„ã«ã™ã‚‹ |
+----------+------------------------------------------+

â€»ä»•æ§˜æ ¹æ‹ ï¼š

âœ”å¿œå‹Ÿ/ã‚¹ã‚«ã‚¦ãƒˆç™ºç”Ÿæ™‚ã«threadè‡ªå‹•ä½œæˆ

å¿œå‹Ÿãƒ»ã‚¹ã‚«ã‚¦ãƒˆãƒ»ãƒãƒ£ãƒƒãƒˆã®ã€Œç™ºç”Ÿãƒˆãƒªã‚¬ãƒ¼ã€ã®é–¢ä¿‚æ€§

âœ” threadã¯ä¼æ¥­ Ã— ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ Ã— æ¡ˆä»¶(or null)ã§1ã¤ã«çµ±ä¸€

ã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆãƒãƒ£ãƒƒãƒˆï¼‰ãŒä½•ã‚’è»¸ã«ç´ã¥ãã‹

âœ” æœªèª­ã¯ã€Œæœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡è€…ãŒè‡ªåˆ†ä»¥å¤–ãªã‚‰æœªèª­ã€

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥ã®æ‰±ã„

---

---

# â‘  showï¼ˆãƒãƒ£ãƒƒãƒˆç”»é¢ã®è¡¨ç¤ºï¼‰

### ğŸŒ± å½¹å‰²

ä¼æ¥­ãŒ **ã‚¹ã‚«ã‚¦ãƒˆæ¸ˆã¿ or å¿œå‹Ÿã•ã‚ŒãŸ thread ã‚’é–‹ãã€
ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’é–²è¦§ã—ã€æœªèª­ã‚’è§£é™¤ã™ã‚‹**

â€»ã‚¹ã‚«ã‚¦ãƒˆãƒãƒ£ãƒƒãƒˆã¨å¿œå‹Ÿãƒãƒ£ãƒƒãƒˆã®ä¸¡æ–¹ã§ä½¿ç”¨ã•ã‚Œã‚‹

---

### ğŸ¯ å…¥å£

```
GET /company/threads/{thread}
```

ã¾ãŸã¯

```
GET /threads/{thread}
```

â€»ã‚¹ã‚«ã‚¦ãƒˆä¸€è¦§ãƒ»å¿œå‹Ÿä¸€è¦§ã‹ã‚‰é·ç§»ã—ã¦ãã‚‹

---

### ğŸ“¤ å‡ºå£ï¼ˆè¿”å´ã™ã‚‹å†…å®¹ï¼‰

ã‚¹ãƒ¬ãƒƒãƒ‰ã®ç¨®é¡ã«å¿œã˜ã¦ä»¥ä¸‹ã®ãƒ“ãƒ¥ãƒ¼ã‚’è¿”ã™ï¼š

- **ã‚¹ã‚«ã‚¦ãƒˆãƒãƒ£ãƒƒãƒˆã®å ´åˆï¼š** `company/scouts/show.blade.php`
- **å¿œå‹Ÿãƒãƒ£ãƒƒãƒˆã®å ´åˆï¼š** `company/messages/show.blade.php`

ç”»é¢ã«ã¯ï¼š

+------------------------+------------------------------------------+
| è¡¨ç¤ºå†…å®¹               | èª¬æ˜                                      |
+------------------------+------------------------------------------+
| ãƒãƒ£ãƒƒãƒˆç›¸æ‰‹ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹å | thread.freelancer.display_name          |
| linked jobï¼ˆæ¡ˆä»¶åï¼‰   | thread.job.title or "æ¡ˆä»¶æœªæŒ‡å®š"         |
| æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸       | thread.scout.messageï¼ˆã‚¹ã‚«ã‚¦ãƒˆæ–‡ï¼‰       |
|                        | thread.application.messageï¼ˆå¿œå‹Ÿæ–‡ï¼‰       |
| messageä¸€è¦§           | æ™‚ç³»åˆ—é †ï¼ˆsent_atï¼‰                      |
| æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›æ¬„   | textareaï¼‹é€ä¿¡button                     |
| å‰Šé™¤ãƒœã‚¿ãƒ³             | ã€Œè‡ªåˆ†ãŒæœ€å¾Œã«é€ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã ã‘å¯ï¼ˆä»•æ§˜ï¼‰ |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ‡æ›¿         | å¿œå‹Ÿã®å ´åˆã®ã¿ï¼šæœªå¯¾å¿œâ†’å¯¾å¿œä¸­â†’ã‚¯ãƒ­ãƒ¼ã‚º   |
+------------------------+------------------------------------------+

---

### ğŸ§  Controllerå†…éƒ¨å‡¦ç†

+----------------------------+--------------------------+
| ã‚¹ãƒ†ãƒƒãƒ—                   | å†…å®¹                      |
+----------------------------+--------------------------+
| â‘  èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶å–å¾—       | role=company              |
| â‘¡ threadå–å¾—               | Route Model Binding       |
| â‘¢ threadå¯¾è±¡ä¼æ¥­æ¨©é™ãƒã‚§ãƒƒã‚¯ | ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢     |
| â‘£ é–¢é€£ãƒ‡ãƒ¼ã‚¿å–å¾—           | Eager Loading             |
|                            | - freelancer              |
|                            | - scoutï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰   |
|                            | - applicationï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ |
|                            | - jobï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰     |
|                            | - messages                |
| â‘¤ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚½ãƒ¼ãƒˆ         | sent_atã§æ™‚ç³»åˆ—é †         |
| â‘¥ æœªèª­è§£é™¤å‡¦ç†             | **serviceã«å§”è­²** â†’ threadå˜ä½ |
| â‘¦ ãƒ“ãƒ¥ãƒ¼åˆ¤å®š               | thread.scoutå­˜åœ¨â†’scouts/show |
|                            | thread.applicationå­˜åœ¨â†’messages/show |
+----------------------------+--------------------------+

â—é‡è¦

æœªèª­è§£é™¤ã¯ã€Œthreadèª­ã‚€ã ã‘ã ã¨ä¸è¦ï¼Ÿã€ã¨æ„Ÿã˜ãŒã¡ã§ã™ãŒ

- æœªèª­ãƒãƒƒã‚¸ã‚’OFFã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° or ãƒ•ãƒ©ã‚°æ›´æ–°ãŒå¿…è¦

â¡ Controllerã«ã¯ç½®ã‹ãš

```
MessageService::markRead(thread, company)
```

ã§ä¸€æ‹¬å‡¦ç†ã«ã™ã‚‹ã€‚

---

### ğŸ’¡ Service å´ã«å¿…é ˆã¨ãªã‚‹å‡¦ç†

Service::markRead å®Ÿè¡Œæ™‚ã«è¡Œã†å‡¦ç†ğŸ‘‡

- threads.is_unread_for_company ã‚’ false ã«æ›´æ–°
- ã‚¹ãƒ¬ãƒƒãƒ‰å˜ä½ã§æœªèª­ç®¡ç†
- ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã„ãŸæ™‚ç‚¹ã§æ—¢èª­æ‰±ã„

---

---

# â‘¡ storeï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†ï¼‰

### ğŸŒ± å½¹å‰²

- ãƒãƒ£ãƒƒãƒˆç”»é¢ã§é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
    
    â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿å­˜ ï¼‹ æ—¢èª­çŠ¶æ…‹æ›´æ–° ï¼‹ æœªèª­ãƒãƒƒã‚¸åˆ¶å¾¡
    
    â€»è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ãŒçµ¡ã‚€ãŸã‚ **Serviceå¿…é ˆ**
    

---

### ğŸ¯ å…¥å£

```
POST /threads/{thread}/messages
payload:
- contentï¼ˆæœ¬æ–‡ï¼‰
```

---

### ğŸ§  Controllerå†…éƒ¨å‡¦ç†

ã‚„ã‚‹ã“ã¨ã¯æœ€å°é™ğŸ‘‡

+------------------+------------------------------+
| Step             | å†…å®¹                         |
+------------------+------------------------------+
| â‘  èªè¨¼ãƒ¦ãƒ¼ã‚¶å–å¾— | Auth::user()                 |
| â‘¡ threadå–å¾—     | Route Binding                |
| â‘¢ æ¨©é™ãƒã‚§ãƒƒã‚¯   | threadã®å½“äº‹è€…ã‹             |
| â‘£ è»½ã„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | content required          |
| â‘¤ Serviceã¸å‡¦ç†å§”è­² | MessageService::send(...) |
| â‘¥ redirectå…ƒç”»é¢ã¸ | thread.show ã¸             |
+------------------+------------------------------+

---

### ğŸ’¡ Service å´ã«å¿…é ˆã¨ãªã‚‹å‡¦ç†

Service::send å®Ÿè¡Œæ™‚ã«è¡Œã†å‡¦ç†ğŸ‘‡

- messages ãƒ†ãƒ¼ãƒ–ãƒ« insert
- threads.updated_at æ›´æ–°
- thread ã®æœªèª­ãƒ•ãƒ©ã‚°æ›´æ–°

ï¼ˆPDFä»•æ§˜ï¼šã€Œæœªèª­åˆ¤å®šã¯æœ€å¾Œã®é€ä¿¡è€…ã‚’è¦‹ã‚‹æ–¹å¼ã€

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥ã®æ‰±ã„ï¼‰

- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡è€…ã‚’æ›´æ–°
- ã‚¹ãƒ¬ãƒƒãƒ‰å˜ä½ã§æœªèª­ã«åˆ‡æ›¿
    
    ï¼ˆç›¸æ‰‹å´ãŒè‡ªåˆ†ä»¥å¤–ã®å ´åˆï¼‰
    

---

### ğŸ“¤ å‡ºå£

```
redirect /threads/{thread}
Flash: ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸã€
```

è¡¨ç¤ºæ›´æ–°ã¯PVå‡¦ç†ã®ãŸã‚ Controllerã«ã¯è²¬å‹™ãªã—ã€‚

---

### ğŸ§© ã‚µãƒ¼ãƒ“ã‚¹ãŒå¿…è¦ãªç†ç”±

- ã‚¹ãƒ¬ãƒƒãƒ‰æœªèª­åˆ¶å¾¡ãŒPDFã§è¤‡é›‘ä»•æ§˜
- messages + threads ã®æ›´æ–°ãŒåŒæ™‚ç™ºç”Ÿ
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¿…è¦
- ControllerãŒæŒã¤ã¨è²¬å‹™éå¤šã«ãªã‚‹

---

---

---

# â‘¢ destroyï¼ˆç›´å‰ã®è‡ªåˆ†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ï¼‰

### ğŸŒ± å½¹å‰²

- ãƒãƒ£ãƒƒãƒˆå†…ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ **è‡ªåˆ†ãŒæœ€å¾Œã«é€ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿** å‰Šé™¤ã§ãã‚‹å‡¦ç†
- DBæ›´æ–°ã¯ message å‰Šé™¤ã®ã¿
    
    â†’ threadsæœªèª­æ›´æ–°ä¸è¦ï¼ˆPDFã«å‰Šé™¤æ™‚æŒ™å‹•è¦å®šãªã—ï¼‰
    

---

### ğŸ¯ å…¥å£

```
DELETE /threads/{thread}/messages/{message}

```

---

### ğŸ§  Controllerå†…éƒ¨å‡¦ç†

+------------------+----------------------------------+
| Step             | å†…å®¹                             |
+------------------+----------------------------------+
| â‘  èªè¨¼ãƒ¦ãƒ¼ã‚¶å–å¾— | Auth::user()                     |
| â‘¡ threadå–å¾—     | RouteBinding                     |
| â‘¢ messageå–å¾—    | RouteBinding                     |
| â‘£ æ¨©é™ãƒã‚§ãƒƒã‚¯   | message.sender_id == user.id     |
| â‘¤ å‰Šé™¤å®Ÿè¡Œ       | message->delete()                |
| â‘¥ redirect back  | thread.showã¸                     |
+------------------+----------------------------------+

---

### Serviceã‚’ä½¿ã‚ãªã„ç†ç”±

- å‰Šé™¤å¯¾è±¡ãŒ message 1ä»¶ã®ã¿
- å‰Šé™¤å¾Œå‰¯ä½œç”¨ãŒãªã„
- åˆ¶ç´„ã¯ Controllerå†…ã§æ‹…ä¿ã§ãã‚‹ãŸã‚

---

### ğŸ“¤ å‡ºå£

```
redirect /threads/{thread}
Flash: ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€

```

---

---

# ğŸ“Œ CompanyMessageController ã¾ã¨ã‚

+----------+------------------------+------------------------+------------------+
| ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | å½¹å‰²                  | Serviceåˆ©ç”¨            | ç†ç”±             |
+----------+------------------------+------------------------+------------------+
| show     | threadè¡¨ç¤ºï¼‹æœªèª­è§£é™¤   | MessageService::markRead | æœªèª­ãƒ•ãƒ©ã‚°æ›´æ–°   |
| store    | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿å­˜ï¼‹æœªèª­æ›´æ–° | MessageService::send   | è¤‡æ•°æ›´æ–°ãƒ»æœªèª­åˆ¶å¾¡ | |
| destroy  | æœ€æ–°ã®è‡ªåˆ†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ | âŒ ãªã—                | å˜ç´”å‰Šé™¤ã®ã¿     |
+----------+------------------------+------------------------+------------------+
